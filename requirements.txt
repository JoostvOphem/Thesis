TODO: give the final environment here